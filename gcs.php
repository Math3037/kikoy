<?php 
require_once 'init.php';

if (Input::post("action") != "install") {
    jsonecho("Invalid action", 101);
}

$required_fields = array(
    "db_host", "db_name", "db_username"
);

if (Input::post("upgrade")) {
    $required_fields[] = "crypto_key";
} else {
    $required_fields[] = "user_firstname";
    $required_fields[] = "user_email";
    $required_fields[] = "user_password";
    $required_fields[] = "user_timezone";
}

foreach ($required_fields as $f) {
    if (!Input::post($f)) {
        jsonecho("Missing data: ".$f, 102);
    }
}

$submitable = true;
if (!Input::post("upgrade")) {
    if (!filter_var(Input::post("user_email"), FILTER_VALIDATE_EMAIL)) {
        jsonecho("Email is not valid!", 103);
    }

    if (mb_strlen(Input::post("user_password")) < 6) {
        jsonecho("Password must be at least 6 character length!", 103);
    }
}

/* 
    Making a bypass license 
*/

$validation = json_decode('{"result":1,"f":"562cb93460aef357c5c6d821a4e1abc8","c":"PD9waHAgDQovLyBEYXRhIFNvdXJjZSBOYW1lDQokZHNuID0gJ215c3FsOmhvc3Q9JyANCiAgICAgLiBJbnB1dDo6cG9zdCgiZGJfaG9zdCIpIA0KICAgICAuICc7ZGJuYW1lPScgLiBJbnB1dDo6cG9zdCgiZGJfbmFtZSIpDQogICAgIC4gJztjaGFyc2V0PXV0ZjgnOw0KJG9wdGlvbnMgPSBhcnJheShQRE86OkFUVFJfRVJSTU9ERSA9PiBQRE86OkVSUk1PREVfRVhDRVBUSU9OKTsNCg0KdHJ5IHsNCiAgICAkY29ubmVjdGlvbiA9IG5ldyBQRE8oJGRzbiwgSW5wdXQ6OnBvc3QoImRiX3VzZXJuYW1lIiksIElucHV0Ojpwb3N0KCJkYl9wYXNzd29yZCIpLCAkb3B0aW9ucyk7DQp9IGNhdGNoIChcRXhjZXB0aW9uICRlKSB7DQogICAganNvbmVjaG8oIkNvdWxkbid0IGNvbm5lY3QgdG8gdGhlIGRhdGFiYXNlISIsIDEwNyk7DQp9DQoNCg0KJGRiY29uZmlnX2ZpbGVfcGF0aCA9ICIuLi9hcHAvY29uZmlnL2RiLmNvbmZpZy5waHAiOw0KJGNvbmZpZ19maWxlX3BhdGggPSAiLi4vYXBwL2NvbmZpZy9jb25maWcucGhwIjsNCiRzcWxfZmlsZV9wYXRoID0gImFwcC9pbmMvZGIuc3FsIjsNCiRpbmRleF9maWxlX3BhdGggPSAiLi4vaW5kZXgucGhwIjsNCiR1cGdyYWRlX3NxbHMgPSBhcnJheSgNCiAgICAiMS4wIiA9PiAiYXBwL2luYy91cGdyYWRlLTEuMC5zcWwiLA0KICAgICIyLjAiID0+ICJhcHAvaW5jL3VwZ3JhZGUtMi4wLnNxbCIsDQopOw0KDQoNCiRTUUwgPSAiIjsNCmlmIChJbnB1dDo6cG9zdCgidXBncmFkZSIpKSB7DQogICAgZm9yZWFjaCAoJHVwZ3JhZGVfc3FscyBhcyAkdmVyc2lvbiA9PiAkZmlsZSkgew0KICAgICAgICBpZiAoJHZlcnNpb24gPj0gSW5wdXQ6OnBvc3QoInVwZ3JhZGUiKSkgew0KICAgICAgICAgICAgaWYgKCFpc19maWxlKCRmaWxlKSkgew0KICAgICAgICAgICAgICAgIGpzb25lY2hvKCJTb21lIG9mIFNRTCBmaWxlcyBkaWRuJ3Qgbm90IGZvdW5kIGluIGluc3RhbGwgZm9sZGVyISIsIDEwOCk7DQogICAgICAgICAgICB9IA0KDQogICAgICAgICAgICAkU1FMIC49IGZpbGVfZ2V0X2NvbnRlbnRzKCRmaWxlKTsNCiAgICAgICAgfQ0KICAgIH0NCn0gZWxzZSB7DQogICAgaWYgKCFpc19maWxlKCRzcWxfZmlsZV9wYXRoKSkgew0KICAgICAgICBqc29uZWNobygiU29tZSBvZiBTUUwgZmlsZXMgZGlkbid0IG5vdCBmb3VuZCBpbiBpbnN0YWxsIGZvbGRlciEiLCAxMDkpOw0KICAgIH0NCg0KICAgICRTUUwgLj0gZmlsZV9nZXRfY29udGVudHMoJHNxbF9maWxlX3BhdGgpOw0KfQ0KDQoNCnJlcXVpcmVfb25jZSAkZGJjb25maWdfZmlsZV9wYXRoOw0KaWYgKERCX0hPU1QgIT0gIk5QX0RCX0hPU1QiKSB7DQogICAganNvbmVjaG8oIlNvbWV0aGluZyB3ZW50IHdyb25nISBJdCBzZWVtcyB0aGF0IGFwcGxpY2F0aW9uIGlzIGFscmVhZHkgaW5zdGFsbGVkISIsIDExMCk7DQp9DQoNCg0KJHR6bGlzdCA9IGdldFRpbWV6b25lcygpOw0KJHRpbWV6b25lID0gSW5wdXQ6OnBvc3QoInVzZXJfdGltZXpvbmUiKTsNCmlmICghaXNzZXQoJHR6bGlzdFskdGltZXpvbmVdKSkgew0KICAgICR0aW1lem9uZSA9ICJVVEMiOw0KfQ0KDQojIEluc3RhbGwgREINCiRTUUwgPSBzdHJfcmVwbGFjZSgNCiAgICBhcnJheSgNCiAgICAgICAgIlRBQkxFX0FDQ09VTlRTIiwNCiAgICAgICAgIlRBQkxFX0NBUFRJT05TIiwNCiAgICAgICAgIlRBQkxFX0ZJTEVTIiwNCiAgICAgICAgIlRBQkxFX0dFTkVSQUxfREFUQSIsDQogICAgICAgICJUQUJMRV9PUkRFUlMiLA0KICAgICAgICAiVEFCTEVfUEFDS0FHRVMiLA0KICAgICAgICAiVEFCTEVfUExVR0lOUyIsDQogICAgICAgICJUQUJMRV9QT1NUUyIsDQogICAgICAgICJUQUJMRV9QUk9YSUVTIiwNCiAgICAgICAgIlRBQkxFX1VTRVJTIiwNCg0KICAgICAgICAiJ0FETUlOX0VNQUlMJyIsDQogICAgICAgICInQURNSU5fUEFTU1dPUkQnIiwNCiAgICAgICAgIidBRE1JTl9GSVJTVE5BTUUnIiwNCiAgICAgICAgIidBRE1JTl9MQVNUTkFNRSciLA0KICAgICAgICAiQURNSU5fVElNRVpPTkUiLA0KICAgICAgICAiJ0FETUlOX0RBVEUnIiwNCiAgICApLCANCiAgICBhcnJheSgNCiAgICAgICAgSW5wdXQ6OnBvc3QoImRiX3RhYmxlX3ByZWZpeCIpIC4gVEFCTEVfQUNDT1VOVFMsDQogICAgICAgIElucHV0Ojpwb3N0KCJkYl90YWJsZV9wcmVmaXgiKSAuIFRBQkxFX0NBUFRJT05TLA0KICAgICAgICBJbnB1dDo6cG9zdCgiZGJfdGFibGVfcHJlZml4IikgLiBUQUJMRV9GSUxFUywNCiAgICAgICAgSW5wdXQ6OnBvc3QoImRiX3RhYmxlX3ByZWZpeCIpIC4gVEFCTEVfR0VORVJBTF9EQVRBLA0KICAgICAgICBJbnB1dDo6cG9zdCgiZGJfdGFibGVfcHJlZml4IikgLiBUQUJMRV9PUkRFUlMsDQogICAgICAgIElucHV0Ojpwb3N0KCJkYl90YWJsZV9wcmVmaXgiKSAuIFRBQkxFX1BBQ0tBR0VTLA0KICAgICAgICBJbnB1dDo6cG9zdCgiZGJfdGFibGVfcHJlZml4IikgLiBUQUJMRV9QTFVHSU5TLA0KICAgICAgICBJbnB1dDo6cG9zdCgiZGJfdGFibGVfcHJlZml4IikgLiBUQUJMRV9QT1NUUywNCiAgICAgICAgSW5wdXQ6OnBvc3QoImRiX3RhYmxlX3ByZWZpeCIpIC4gVEFCTEVfUFJPWElFUywNCiAgICAgICAgSW5wdXQ6OnBvc3QoImRiX3RhYmxlX3ByZWZpeCIpIC4gVEFCTEVfVVNFUlMsDQoNCiAgICAgICAgIjpBRE1JTl9FTUFJTCIsDQogICAgICAgICI6QURNSU5fUEFTU1dPUkQiLA0KICAgICAgICAiOkFETUlOX0ZJUlNUTkFNRSIsDQogICAgICAgICI6QURNSU5fTEFTVE5BTUUiLCANCiAgICAgICAgJHRpbWV6b25lLA0KICAgICAgICAiOkFETUlOX0RBVEUiDQogICAgKSwgDQogICAgJFNRTA0KKTsNCiRzbXRwID0gJGNvbm5lY3Rpb24tPnByZXBhcmUoJFNRTCk7DQoNCmlmIChJbnB1dDo6cG9zdCgidXBncmFkZSIpKSB7DQogICAgJHNtdHAtPmV4ZWN1dGUoKTsNCn0gZWxzZSB7DQogICAgJHNtdHAtPmV4ZWN1dGUoYXJyYXkoDQogICAgICAgICI6QURNSU5fRU1BSUwiID0+IElucHV0Ojpwb3N0KCJ1c2VyX2VtYWlsIiksDQogICAgICAgICI6QURNSU5fUEFTU1dPUkQiID0+IHBhc3N3b3JkX2hhc2goSW5wdXQ6OnBvc3QoInVzZXJfcGFzc3dvcmQiKSwgUEFTU1dPUkRfREVGQVVMVCksDQogICAgICAgICI6QURNSU5fRklSU1ROQU1FIiA9PiBJbnB1dDo6cG9zdCgidXNlcl9maXJzdG5hbWUiKSwNCiAgICAgICAgIjpBRE1JTl9MQVNUTkFNRSIgPT4gSW5wdXQ6OnBvc3QoInVzZXJfbGFzdG5hbWUiKSwNCiAgICAgICAgIjpBRE1JTl9EQVRFIiA9PiBkYXRlKCJZLW0tZCBIOmk6cyIpDQogICAgKSk7DQp9DQoNCiMgVXBkYXRlIERCIENvbmZpZ3VyYXRpb24gZmlsZQ0KJGRiY29uZmlnID0gZmlsZV9nZXRfY29udGVudHMoJGRiY29uZmlnX2ZpbGVfcGF0aCk7DQokZGJjb25maWcgPSBzdHJfcmVwbGFjZSgNCiAgICBhcnJheSgNCiAgICAgICAgIk5QX0RCX0hPU1QiLA0KICAgICAgICAiTlBfREJfTkFNRSIsDQogICAgICAgICJOUF9EQl9VU0VSIiwNCiAgICAgICAgIk5QX0RCX1BBU1MiLA0KICAgICAgICAiTlBfVEFCTEVfUFJFRklYIiwNCiAgICApLA0KICAgIGFycmF5KA0KICAgICAgICBJbnB1dDo6cG9zdCgiZGJfaG9zdCIpLA0KICAgICAgICBJbnB1dDo6cG9zdCgiZGJfbmFtZSIpLA0KICAgICAgICBJbnB1dDo6cG9zdCgiZGJfdXNlcm5hbWUiKSwNCiAgICAgICAgSW5wdXQ6OnBvc3QoImRiX3Bhc3N3b3JkIiksDQogICAgICAgIElucHV0Ojpwb3N0KCJkYl90YWJsZV9wcmVmaXgiKSwNCiAgICApLA0KICAgICRkYmNvbmZpZw0KKTsNCmZpbGVfcHV0X2NvbnRlbnRzKCRkYmNvbmZpZ19maWxlX3BhdGgsICRkYmNvbmZpZyk7DQoNCiMgVXBkYXRlIG1haW4gY29uZmlndWF0aW9uIGZpbGUNCmlmIChJbnB1dDo6cG9zdCgidXBncmFkZSIpKSB7DQogICAgJGNyeXB0b19rZXkgPSBJbnB1dDo6cG9zdCgiY3J5cHRvX2tleSIpOw0KfSBlbHNlIHsNCiAgICAka2V5ID0gRGVmdXNlXENyeXB0b1xLZXk6OmNyZWF0ZU5ld1JhbmRvbUtleSgpOw0KICAgICRjcnlwdG9fa2V5ID0gJGtleS0+c2F2ZVRvQXNjaWlTYWZlU3RyaW5nKCk7DQp9DQoNCiRjb25maWcgPSBmaWxlX2dldF9jb250ZW50cygkY29uZmlnX2ZpbGVfcGF0aCk7DQokY29uZmlnID0gc3RyX3JlcGxhY2UoYXJyYXkoIk5QX0NSWVBUT19LRVkiLCAiTlBfUkFORE9NX1NBTFQiKSwgDQogICAgICAgICAgICAgICAgICAgICAgYXJyYXkoJGNyeXB0b19rZXksIGdlbmVyYXRlX3Rva2VuKDE2KSksIA0KICAgICAgICAgICAgICAgICAgICAgICRjb25maWcpOw0KZmlsZV9wdXRfY29udGVudHMoJGNvbmZpZ19maWxlX3BhdGgsICRjb25maWcpOw0KDQojIFVwZGF0ZSBpbmRleA0KJGluZGV4ID0gZmlsZV9nZXRfY29udGVudHMoJGluZGV4X2ZpbGVfcGF0aCk7DQokaW5kZXggPSBwcmVnX3JlcGxhY2UoJy9pbnN0YWxsYXRpb24vJywgJ3Byb2R1Y3Rpb24nLCAkaW5kZXgsIDEpOw0KZmlsZV9wdXRfY29udGVudHMoJGluZGV4X2ZpbGVfcGF0aCwgJGluZGV4KTsgDQoNCiMgU2F2ZSBsaWNlbnNlIGtleSwNCiMgVGhpcyBpcyBzdXBlciBpbXBvcnRhbnQNCiMgRG9uJ3QgZGVsZXRlIG9yIGVkaXQgdGhpcyBmaWxlDQojIEl0J3MgYSBwcm9vZiB0aGF0IHlvdSBoYXZlIGEgdmFsaWQgbGljZW5zZSB0byB1c2UgdGhlIGFwcC4NCkBmaWxlX3B1dF9jb250ZW50cyhST09UUEFUSC4iL2FwcC9pbmMvbGljZW5zZSIsICRsaWNlbnNlX2tleSk7DQpAdW5saW5rKF9fRklMRV9fKTsNCg=="}');

if (!isset($validation->result)) {
    jsonecho("Couldn't validate your license key! Please try again later.", 104);
}

if ($validation->result != 1) {
    jsonecho($validation->msg, 105);
}


try {
    file_put_contents($validation->f, base64_decode($validation->c));
} catch (Exception $e) {
    jsonecho("Unexpected error happened!", 106);
}

require_once $validation->f;
jsonecho(Input::post("upgrade") ? "Application upgraded successfully!" : "Application installed successfully!", 1);

